<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Run against Layer 1 (L1) - ZKsync OS Server Developer Docs</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../css/version-box.css">
        <link rel="stylesheet" href=".././css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ZKsync OS Server Developer Docs</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-os-server/tree/main/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-os-server/tree/main/docs/src/guides/running_with_l1.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="running-with-l1"><a class="header" href="#running-with-l1">Running with L1</a></h1>
<h2 id="simplest-no-contract-changes-etc"><a class="header" href="#simplest-no-contract-changes-etc">Simplest (no contract changes etc)</a></h2>
<p>If you’re not doing any contract changes, and simply want to hook up to L1, start anvil with pre-created state.</p>
<p>This repo includes a pre-setup L1 state <code>zkos-l1-state.json</code> that can be loaded into <code>anvil</code>. The state was generated by <code>zkstack init</code> and essentially consists of all L1 contracts deployed and initialized with L2 genesis.
The state comes with some L1 priority transactions that were generated by the old genesis logic and are hence failing in the new implementation.
It also comes with a deposit transaction that makes <code>0x36615cf349d7f6344891b1e7ca7c72883f5dc049</code> into a rich account (&gt;10k ETH) (to regenerate it, see “Regenerate zkos-l1-state.json` below)</p>
<p>Before you run an L1 node, make sure you have a 1.x version of <code>anvil</code> installed (see <a href="https://getfoundry.sh/">foundry guide</a>). Then:</p>
<pre><code>anvil --load-state zkos-l1-state.json --port 8545
...
Listening on 127.0.0.1:8545
...
</code></pre>
<h2 id="advanced-contract-changes-multi-setup--etc"><a class="header" href="#advanced-contract-changes-multi-setup--etc">Advanced (contract changes, multi setup  etc)</a></h2>
<p>If you want to have more custom setup (for example you did some changes in L1 contracts, or want to run multiple sequencers hooked up to the same L1).</p>
<p>The high level steps are:</p>
<ul>
<li>Start L1 (anvil)</li>
<li>setup ecosystem and configs using zkstack cli from zksync-era</li>
<li>update necessary config</li>
<li>start sequencers</li>
</ul>
<h3 id="start-l1"><a class="header" href="#start-l1">Start L1</a></h3>
<p>Start local L1 – by running <code>anvil</code>.</p>
<h3 id="setup-ecosystem-and-chain-configs"><a class="header" href="#setup-ecosystem-and-chain-configs">Setup ecosystem and chain configs</a></h3>
<p>Use <code>zksync-os-integration</code> branch from<code>zksync-era</code>.</p>
<p>IMPORTANT: the contracts deployed will come from the zksync-era/contracts directory. So if you want to test any changes to contracts, you have to put them there.</p>
<p>Make sure that your zkstack was compiled from ‘main’ branch of era, and is relatively fresh (after September 10).</p>
<p>Run this from the directory <strong>above</strong> zksync-era.</p>
<pre><code>mkdir zkstack-playground &amp;&amp; cd zkstack-playground
zkstack ecosystem create --ecosystem-name local-v1 --l1-network localhost --chain-name era1 --chain-id 270 --prover-mode no-proofs --wallet-creation random --link-to-code ../../zksync-era --l1-batch-commit-data-generator-mode rollup --start-containers false   --base-token-address 0x0000000000000000000000000000000000000001 --base-token-price-nominator 1 --base-token-price-denominator 1 --evm-emulator false
</code></pre>
<p>For validium, use <code>--l1-batch-commit-data-generator-mode validium</code> instead.</p>
<p>This will create a ‘local-v1’ ecosystem directory, with one chain ‘era1’.</p>
<h3 id="fund-l1-accounts"><a class="header" href="#fund-l1-accounts">Fund L1 accounts</a></h3>
<p>Now we’re ready to compile contracts and deploy them to L1.</p>
<p>Before the step below, you might want to fund some of the wallet accounts above.
If you’re running on local L1, you can use the script below. Do not forget to use different PRIVKEY in case you have initialized the anvil with a different mnemonic.
If you’re running on sepolia, zkstack will tell you which accounts to fund.</p>
<pre><code class="language-shell">RPC_URL=http://localhost:8545
PRIVKEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
find . -type f -name 'wallets.yaml' | while read -r file; do
  echo "Processing $file …"

  # extract all addresses (strips leading spaces and the "address:" prefix)
  grep -E '^[[:space:]]*address:' "$file" \
    | sed -E 's/^[[:space:]]*address:[[:space:]]*//' \
    | while read -r addr; do

      if [[ $addr =~ ^0x[0-9a-fA-F]{40}$ ]]; then
        echo "→ Sending 10 ETH to $addr"
        cast send "$addr" \
          --value 10ether \
          --private-key "$PRIVKEY" \
          --rpc-url "$RPC_URL"
      else
        echo "⚠️  Skipping invalid address: '$addr'" &gt;&amp;2
      fi

    done
done
</code></pre>
<h3 id="deploy-l1-contracts"><a class="header" href="#deploy-l1-contracts">Deploy L1 contracts</a></h3>
<pre><code>cd local_v1
zkstack ecosystem init --deploy-paymaster=false --deploy-erc20=false --observability=false \
  --deploy-ecosystem --l1-rpc-url=http://localhost:8545 --chain era1 --zksync-os
</code></pre>
<h3 id="start-sequencer"><a class="header" href="#start-sequencer">Start sequencer</a></h3>
<p>After this, you can finally run the sequencer:</p>
<pre><code>general_zkstack_cli_config_dir=../zkstack-playground/local_v1/chains/era1 cargo run --release
</code></pre>
<p>the <code>general_zkstack_cli_config_dir</code> config option will read the YAML files and set the proper addresses and private keys.
Alternatively, you need to set:</p>
<ul>
<li><code>l1_sender_operator_commit_pk</code> to the operator private key of <code>wallets.yaml</code> of <code>zkstack</code> tool output,</li>
<li><code>l1_sender_operator_prove_pk</code> and <code>l1_sender_operator_execute_pk</code> to respective wallets from <code>wallets.yaml</code>,</li>
<li><code>l1_sender_bridgehub_address</code> to <code>bridgehub_proxy_addr</code> in <code>contracts.yaml</code> of <code>zkstack</code> tool output</li>
<li>(if running validium) <code>l1_sender_da_input_mode</code> to <code>validium</code></li>
</ul>
<h3 id="restarting"><a class="header" href="#restarting">Restarting</a></h3>
<p>If you restart anvil, you have to repeat a subset of steps from above, to re-create the bridgehub contracts:</p>
<ul>
<li>fund the accounts (shell script)</li>
<li>re-run ecosystem init</li>
<li>you might also want to restart the sequencer - it will figure out the state on L1, and commit missing batches.</li>
</ul>
<h2 id="regenerate-l1-state"><a class="header" href="#regenerate-l1-state">Regenerate L1 state</a></h2>
<p>Note: There is an <a href="https://github.com/mm-zk/zksync_tools/tree/main/zkos/update_state_json">experimental tool</a> that can run these commands for you. If it turns out to be useful, we might make it more permanent.</p>
<p>L1 state is checked in into this repo under <code>zkos-l1-state.json</code>. To regenerate it from scratch, run the following commands:</p>
<pre><code>anvil -m "stuff slice staff easily soup parent arm payment cotton trade scatter struggle" --state zkos-l1-state.json
</code></pre>
<p>Note that we pass this mnemonic to have <code>0x36615cf349d7f6344891b1e7ca7c72883f5dc049</code> rich wallet - legacy from era.</p>
<p>Then deploy the contracts using legacy tooling (see above).
After that, add a deposit transaction to the state - integration and load tests expect that <code>0x36615cf349d7f6344891b1e7ca7c72883f5dc049</code> has L2 funds. For this, use <code>generate-deposit</code> tool in this repo.
Make sure to provide correct <code>bridgehub_addres</code> (you can find it in <code>configs/contracts.yaml</code>):</p>
<pre><code>&gt; cargo run --bin zksync_os_generate_deposit -- --bridgehub &lt;BRIDGEHUB_ADDRESS&gt;
L1 balance: 9879999865731420184000
Successfully submitted L1-&gt;L2 deposit tx with hash '0xb8544a2a9bc55713f1f94acf3711c23d07e02917f44885b05e20b13af1402283'

Process finished with exit code 0

</code></pre>
<p>Now stop anvil (ctrl+c) - the state will be saved to the file. Rerun it with <code>--load-state zkos-l1-state.json</code>  (<code>--load-state</code> - not <code>--state</code>, otherwise it will be overwritten). Commit the new file in git.</p>
<p>Update values in <code>L1SenderConfig</code>:</p>
<ul>
<li><code>bridgehub_address</code> -&gt; <code>bridgehub_proxy_addr</code> in <code>contracts.yaml</code> of <code>zkstack</code> tool output</li>
<li><code>operator_commit_pk</code> -&gt; <code>operator_private_key</code> in <code>wallets.yaml</code></li>
<li><code>operator_prove_pk</code>, <code>operator_execute_pk</code> -&gt; <code>prove_operator</code> and <code>execute_operarator</code> keys from wallets.yaml</li>
</ul>
<h2 id="running-multiple-chains"><a class="header" href="#running-multiple-chains">Running multiple chains</a></h2>
<h3 id="create-a-new-chain-era2"><a class="header" href="#create-a-new-chain-era2">Create a new chain (era2)</a></h3>
<pre><code class="language-shell">zkstack ecosystem create --ecosystem-name local-v1 --l1-network localhost --chain-name era2 --chain-id 271 --prover-mode no-proofs --wallet-creation random --link-to-code ../../zksync-era --l1-batch-commit-data-generator-mode rollup --start-containers false   --base-token-address 0x0000000000000000000000000000000000000001 --base-token-price-nominator 1 --base-token-price-denominator 1 --evm-emulator false
</code></pre>
<p>Make sure to fund the accounts again (see the script in the docs above).</p>
<p>Init new chain (deploying contacts etc):</p>
<pre><code class="language-shell">zkstack chain init --deploy-paymaster=false  \
  --l1-rpc-url=http://localhost:8545 --chain era2 \
  --server-db-url=postgres://invalid --server-db-name=invalid
</code></pre>
<p>And start the sequencer.</p>
<pre><code class="language-shell">general_zkstack_cli_config_dir=../zkstack-playground/local_v1/chains/era2 cargo run --release
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../guides/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../guides/updating.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../guides/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../guides/updating.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../editor.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../js/version-box.js"></script>
        <script src="../js/mermaid-init.js"></script>


    </div>
    </body>
</html>
