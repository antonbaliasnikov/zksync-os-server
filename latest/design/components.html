<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Components Overview - ZKsync OS Server Developer Docs</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../css/version-box.css">
        <link rel="stylesheet" href=".././css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ZKsync OS Server Developer Docs</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-os-server/tree/main/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-os-server/tree/main/docs/src/design/components.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="component-details"><a class="header" href="#component-details">Component Details</a></h1>
<img width="1549" height="658" alt="Screenshot 2025-07-24 at 15 00 55" src="https://github.com/user-attachments/assets/e1a472bd-d14b-4840-bd89-223347bebccf" />
<p>See individual components and state recovery details in the table below. Note that most components have little to no
internal state or persistence ‚Äî this is one of the design principles.</p>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>In-memory state</th><th>Persistence</th><th>State Recovery</th></tr></thead><tbody>
<tr><td><strong>Command Source</strong></td><td><code>starting_block</code> (only used on startup)</td><td>none</td><td><code>starting_block</code> is the first block <strong>after</strong> the compacted block stored in <code>state</code>, i.e., <code>starting_block = highest_block - blocks_to_retain_in_memory</code>.</td></tr>
<tr><td><strong>BlockContextProvider</strong></td><td><code>next_l1_priority_id</code>; <code>block_hashes_for_next_block</code> (last 256 block hashes)</td><td>none</td><td><code>next_l1_priority_id</code>: take from <code>ReplayRecord</code> of <code>starting_block - 1</code>; <code>block_hashes_for_next_block</code>: take from 256 <code>ReplayRecord</code>s before <code>starting_block</code></td></tr>
<tr><td><strong>L1Watcher</strong></td><td>Gapless list of Priority transactions - starting from the last committed to L1</td><td>none</td><td>none - recovers itself from L1</td></tr>
<tr><td><strong>L2Mempool</strong> <em>(RETH crate)</em></td><td>prepared list of pending L2 transactions</td><td>none</td><td>none (consider persisting mempool transactions in the future)</td></tr>
<tr><td><strong>BlockExecutor</strong></td><td>none üî•</td><td>none</td><td>none</td></tr>
<tr><td><strong>Repositories</strong> (API subsystem)</td><td>BlockHeaders and Transactions for ~<code>blocks_to_retain_in_memory</code> blocks</td><td>Historical BlockHeaders and Transactions</td><td>none - recovers naturally when replaying blocks from <code>starting_block</code></td></tr>
<tr><td><strong>State</strong></td><td>All Storage Logs and Preimages for <code>blocks_to_retain_in_memory</code> last blocks</td><td>Compacted state at some older block (<code>highest_block - blocks_to_retain_in_memory</code>): full state map and all preimages</td><td>none - recovers naturally when replaying blocks from <code>starting_block</code></td></tr>
<tr><td><strong>Merkle Tree</strong></td><td>Only persistence</td><td>Full Merkle tree - including previous values on each leaf</td><td>none</td></tr>
<tr><td>‚¨áÔ∏è <em>Batcher Subsystem Components</em></td><td>‚¨áÔ∏è <em>Components below operate on Batches - not BlocksÔ∏è</em></td><td>‚¨áÔ∏è <em>Components below must not rely on persistence - otherwise failover is not possible</em></td><td>‚¨áÔ∏è</td></tr>
<tr><td><strong>Batcher</strong></td><td>startup: <code>starting_batch</code> and <code>batcher_starting_block</code>; <br/> operation: Trailing Batch‚Äôs <code>CommitBatchInfo</code>;</td><td>none</td><td><code>first_block_to_process</code>: block <strong>after</strong> the last block in the last committed L1 batch;<br/> <code>last_persisted_block</code>: the block after which we start checking for batch timeouts <br/> <code>StoredBatchInfo</code> in <code>run_loop</code>: Currently: from FRI cache; todo - Load last committed <code>StoredBatchInfo</code> from L1 OR reprocess last committed batch</td></tr>
<tr><td><strong>Prover Input Generator</strong></td><td></td><td>none</td><td>none</td></tr>
<tr><td><strong>FRI Job Manager</strong></td><td>Gapless List of unproved batches with <code>ProverInput</code> and prover assignment info</td><td>none</td><td>none - batches before <code>starting_batch</code> are guaranteed to have FRI proofs, batches after will go through the pipeline again</td></tr>
<tr><td><strong>FRI Store/Cache</strong></td><td>none</td><td><code>Map&lt;BatchNumber, FRIProof&gt;</code> (todo: extract from the node process to enable failover)</td><td>none</td></tr>
<tr><td><strong>L1 Committer</strong></td><td>none*</td><td>none</td><td>none - recovers itself from L1</td></tr>
<tr><td><strong>L1 Proof Submitter</strong></td><td>none*</td><td>none</td><td>none - recovers itself from L1</td></tr>
<tr><td><strong>L1 Executor</strong></td><td>none*</td><td>none</td><td>none - recovers itself from L1</td></tr>
<tr><td><strong>SNARK Job Manager</strong> (TODO - missing)</td><td>Gapless list of batches with their FRI proofs and prover assignment info</td><td>none</td><td>Load batches that are committed but not proved on L1 yet. Load their FRI proofs from FRI cache (TODO)</td></tr>
<tr><td><strong>Priority Tree Manager</strong></td><td>Dynamic Merkle tree with L1-&gt;L2 transaction hashes</td><td>Compressed data needed to rebuild the tree, see <code>CachedTreeData</code> for more details</td><td>none - recovers itself from replay storage</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../design/subsystems.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../design/rpc.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../design/subsystems.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../design/rpc.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../editor.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../js/version-box.js"></script>
        <script src="../js/mermaid-init.js"></script>


    </div>
    </body>
</html>
